<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æŒ‰é’®åˆ›å»ºå·¥å…·</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      h1 {
        color: #333;
        text-align: center;
      }

      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .screenshot-container {
        position: relative;
        display: inline-block;
        margin: 10px 0;
      }

      canvas {
        border: 2px solid #ddd;
        cursor: crosshair;
        display: block;
        max-width: 100%;
      }

      .info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .coords {
        background: #f1f8e9;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: "Courier New", monospace;
        font-size: 14px;
      }

      .button-code {
        background: #fff3e0;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }

      button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }

      button:hover {
        background: #1976d2;
      }

      .reset-btn {
        background: #f44336;
      }

      .reset-btn:hover {
        background: #d32f2f;
      }

      .save-btn {
        background: #4caf50;
      }

      .save-btn:hover {
        background: #45a049;
      }

      input[type="text"] {
        margin: 10px 0;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 300px;
      }

      .input-group {
        margin: 15px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <h1>ğŸ¯ æŒ‰é’®åˆ›å»ºå·¥å…·</h1>

    <div class="container">
      <div class="info">
        <h3>ğŸ“– ä½¿ç”¨è¯´æ˜:</h3>
        <p>1. æˆªå›¾ä¼šè‡ªåŠ¨åŠ è½½</p>
        <p>2. åœ¨å›¾ç‰‡ä¸Š<strong>æ‹–åŠ¨é¼ æ ‡</strong>æ¡†é€‰æŒ‰é’®åŒºåŸŸ</p>
        <p>3. è¾“å…¥æŒ‰é’®åç§°ï¼Œç‚¹å‡»"ç”ŸæˆJSON"</p>
        <p>4. å¤åˆ¶JSONï¼Œç²˜è´´åˆ°æ§åˆ¶å°ï¼Œå›è½¦</p>
        <p>5. ç‚¹å‡»"ç»§ç»­é€‰å–"åˆ›å»ºä¸‹ä¸€ä¸ªæŒ‰é’®</p>
        <p>6. æ§åˆ¶å°ç›´æ¥å›è½¦é€€å‡ºå¹¶ä¿å­˜æ‰€æœ‰æŒ‰é’®</p>
      </div>

      <div>
        <h3>æ¡†é€‰æŒ‰é’®åŒºåŸŸ</h3>
        <div class="screenshot-container">
          <canvas id="canvas"></canvas>
        </div>

        <div id="coords" class="coords" style="display: none"></div>

        <div class="input-group" id="nameInput" style="display: none">
          <label for="buttonName">æŒ‰é’®åç§° (å¤§å†™,ç”¨ä¸‹åˆ’çº¿åˆ†éš”):</label>
          <input
            type="text"
            id="buttonName"
            placeholder="ä¾‹å¦‚: PHYSICAL_TEST"
            style="text-transform: uppercase"
          />
        </div>

        <div id="code" class="button-code" style="display: none"></div>

        <button
          onclick="generateButton()"
          class="save-btn"
          id="generateBtn"
          style="display: none"
        >
          ç”ŸæˆJSON
        </button>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      let image = null;
      let selection = {
        startX: 0,
        startY: 0,
        endX: 0,
        endY: 0,
        isDrawing: false,
      };
      let selectedCoords = null;

      // é¼ æ ‡äº‹ä»¶
      canvas.addEventListener("mousedown", startSelection);
      canvas.addEventListener("mousemove", updateSelection);
      canvas.addEventListener("mouseup", endSelection);

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æˆªå›¾
      window.addEventListener("load", function () {
        const img = new Image();
        img.onload = function () {
          image = img;
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const info = document.querySelector(".info");
          info.innerHTML =
            "<h3>âœ“ å·²è‡ªåŠ¨åŠ è½½æˆªå›¾</h3><p><strong>ç°åœ¨å¯ä»¥ç›´æ¥æ¡†é€‰æŒ‰é’®äº†!</strong></p>";
          info.style.background = "#c8e6c9";
        };
        img.onerror = function () {
          console.log("æœªæ‰¾åˆ° temp_screenshot.png");
        };
        img.src = "../temp_screenshot.png?t=" + new Date().getTime();
      });

      function startSelection(e) {
        const rect = canvas.getBoundingClientRect();
        selection.startX = e.clientX - rect.left;
        selection.startY = e.clientY - rect.top;
        selection.isDrawing = true;
      }

      function updateSelection(e) {
        if (!selection.isDrawing) return;

        const rect = canvas.getBoundingClientRect();
        selection.endX = e.clientX - rect.left;
        selection.endY = e.clientY - rect.top;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0);

        ctx.strokeStyle = "#2196F3";
        ctx.lineWidth = 3;
        ctx.strokeRect(
          selection.startX,
          selection.startY,
          selection.endX - selection.startX,
          selection.endY - selection.startY,
        );

        ctx.fillStyle = "rgba(33, 150, 243, 0.2)";
        ctx.fillRect(
          selection.startX,
          selection.startY,
          selection.endX - selection.startX,
          selection.endY - selection.startY,
        );
      }

      function calculateAverageColor(imageData) {
        // è®¡ç®—å›¾åƒæ•°æ®çš„å¹³å‡é¢œè‰²ï¼Œä¸ Python çš„ get_color å‡½æ•°ä¿æŒä¸€è‡´
        const data = imageData.data;
        let r = 0,
          g = 0,
          b = 0;
        const pixels = data.length / 4;

        for (let i = 0; i < data.length; i += 4) {
          r += data[i]; // red
          g += data[i + 1]; // green
          b += data[i + 2]; // blue
        }

        // ä¸ Python ä¸­çš„ cv2.mean è®¡ç®—ç»“æœä¿æŒä¸€è‡´
        return {
          r: Math.round(r / pixels),
          g: Math.round(g / pixels),
          b: Math.round(b / pixels),
        };
      }

      function endSelection(e) {
        if (!selection.isDrawing) return;
        selection.isDrawing = false;

        const rect = canvas.getBoundingClientRect();
        selection.endX = e.clientX - rect.left;
        selection.endY = e.clientY - rect.top;

        // ä¸ Python ä¸­çš„ crop å‡½æ•°ä¿æŒä¸€è‡´çš„åæ ‡å¤„ç†
        const x1 = Math.round(Math.min(selection.startX, selection.endX));
        const y1 = Math.round(Math.min(selection.startY, selection.endY));
        const x2 = Math.round(Math.max(selection.startX, selection.endX));
        const y2 = Math.round(Math.max(selection.startY, selection.endY));

        selectedCoords = { x1, y1, x2, y2 };

        // è®¡ç®—å°ºå¯¸
        const width = x2 - x1;
        const height = y2 - y1;

        // ç¡®ä¿é€‰æ‹©åŒºåŸŸæœ‰æ•ˆ
        if (width <= 0 || height <= 0) {
          alert("è¯·é€‰æ‹©æœ‰æ•ˆçš„æŒ‰é’®åŒºåŸŸï¼");
          return;
        }

        const coordsDiv = document.getElementById("coords");
        coordsDiv.style.display = "block";
        coordsDiv.innerHTML = `
                <strong>âœ“ é€‰æ‹©å®Œæˆ!</strong><br><br>
                åæ ‡: (${x1}, ${y1}, ${x2}, ${y2})<br>
                å°ºå¯¸: ${width} Ã— ${height}<br>
                <span style="color: #666;">ğŸ’¡ é¢œè‰²å°†ç”±Pythonè‡ªåŠ¨è®¡ç®—</span>
            `;

        document.getElementById("nameInput").style.display = "block";
        document.getElementById("generateBtn").style.display = "inline-block";
      }

      function generateButton() {
        const buttonName = document
          .getElementById("buttonName")
          .value.trim()
          .toUpperCase();
        if (!buttonName) {
          alert("è¯·è¾“å…¥æŒ‰é’®åç§°!");
          return;
        }

        if (!selectedCoords) {
          alert("è¯·å…ˆæ¡†é€‰æŒ‰é’®åŒºåŸŸ!");
          return;
        }

        const { x1, y1, x2, y2 } = selectedCoords;
        // JSONæ•°æ®ï¼ˆä¸åŒ…å«é¢œè‰²ï¼ŒPythonä¼šè‡ªåŠ¨è®¡ç®—ï¼‰
        const jsonData = `{"name": "${buttonName}", "coords": [${x1}, ${y1}, ${x2}, ${y2}]}`;
        // ç”Ÿæˆä»£ç é¢„è§ˆï¼ˆé¢œè‰²éƒ¨åˆ†ä¸ºå ä½ç¬¦ï¼‰
        const code = `${buttonName} = Button(area=(${x1}, ${y1}, ${x2}, ${y2}), color=<ç”±Pythonè®¡ç®—>, button=(${x1}, ${y1}, ${x2}, ${y2}), file="./assets/train/${buttonName}.png")`;

        const codeDiv = document.getElementById("code");
        codeDiv.style.display = "block";
        codeDiv.innerHTML = `
<strong>âœ“ JSONå·²ç”Ÿæˆ!</strong><br><br>
<strong>å¤åˆ¶ä¸‹é¢çš„JSONåˆ°æ§åˆ¶å°:</strong><br>
<textarea id="jsonOutput" readonly onclick="this.select()" style="width: 100%; height: 60px; padding: 10px; font-family: monospace; font-size: 14px; margin: 10px 0; border: 2px solid #2196F3; border-radius: 4px; cursor: pointer;">${jsonData}</textarea>
<button onclick="copyJson()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px;">ç‚¹å‡»å¤åˆ¶</button>
<br><br>
<strong>ğŸ’¡ æç¤º:</strong><br>
â€¢ å¤åˆ¶ååˆ°æ§åˆ¶å°ç²˜è´´å¹¶å›è½¦<br>
â€¢ ç›´æ¥å›è½¦é€€å‡ºå¹¶ä¿å­˜æ‰€æœ‰æŒ‰é’®<br>
            `;

        // è‡ªåŠ¨é€‰ä¸­å¹¶æ˜¾ç¤ºç»§ç»­æŒ‰é’®
        setTimeout(() => {
          document.getElementById("jsonOutput").select();
        }, 100);

        document.getElementById("continueBtn").style.display = "inline-block";
      }

      function copyJson() {
        const textarea = document.getElementById("jsonOutput");
        textarea.select();
        try {
          document.execCommand("copy");
          alert("âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!");
        } catch (err) {
          alert("è¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶(Ctrl+C)");
        }
      }
    </script>
  </body>
</html>
