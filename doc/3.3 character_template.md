# 3.3 character_template

本文介绍如何批量提取游戏内角色头像，生成用于模板匹配的 `TEMPLATE_*.png` 文件。

工具链：`dev_tools/droidcast_raw.py` → `dev_tools/extract_avatars.py`

---


游戏内角色选择界面（公会战成员、队伍编成等）的头像以**网格形式**排列，手动逐个截图效率低。`extract_avatars.py` 通过标定 3 个锚点自动推算整个网格，再逐个命名保存

---

## 游戏画面

将游戏切换到包含角色头像的界面，运行：

```bash
python dev_tools/droidcast_raw.py
```

截图保存到 `logs/ui/screenshot_YYYYMMDD_HHMMSS.png`


> 截图分辨率必须为 **1280×720**

---

## 头像提取工具

```bash
python dev_tools/extract_avatars.py --input logs/ui/screenshot_20240101_120000.png

# 指定输出目录（默认 ./assets/character）
python dev_tools/extract_avatars.py --input logs/ui/screenshot_20240101_120000.png --output ./assets/character
```

工具会打开一个 OpenCV 窗口

---

### 标定网格

依次框选 3 个头像，工具通过这 3 个锚点推算整个网格的位置和间距：

| 步骤 | 框选目标 | 作用 |
|------|----------|------|
| 1/3 | 第 1 行第 1 列（R1C1） | 确定网格左上角锚点 |
| 2/3 | 第 1 行最后一列（R1C_last） | 跨整行测量，推算列间距 |
| 3/3 | 第 2 行第 1 列（R2C1） | 确定行间距 |

**操作方式**：

1. 在窗口上拖拽鼠标框选头像
2. 松手后，工具自动将选区修正为正方形（**黄框**预览，灰框为原始选区）
3. 按 **Enter** 接受；若位置不准，重新拖拽即可
4. 按 **q** 或 **ESC** 退出

---

### 垂直微调

标定完成后，绿色网格框叠加在图像上，检查是否与头像完全对齐，用键盘微调 Y 轴：

| 按键 | 效果 |
|------|------|
| `↑` / `↓` | 上下移动 1px |
| `w` / `s` | 上下移动 5px |
| `c` | 放弃，返回重新标定 |
| `Enter` | 确认，进入命名阶段 |
| `q` / `ESC` | 退出工具 |

---

### 逐个命名保存

工具逐个高亮显示头像（当前格蓝色边框 + 右上角 3× 放大预览），在**终端**输入角色名：

```
共 16 个格子，开始逐个命名
  输入名称 → TEMPLATE_<名称>.png  |  Enter=跳过  |  q=结束

  [ 1/16] 角色名（Enter=跳过，q=结束）: 水哈
    已保存 → ./assets/character/TEMPLATE_水哈.png
  [ 2/16] 角色名（Enter=跳过，q=结束）: 水姐
    已保存 → ./assets/character/TEMPLATE_水姐.png
  [ 3/16] 角色名（Enter=跳过，q=结束）:
    跳过
  ...
```

| 输入 | 行为 |
|------|------|
| 角色名 | 保存为 `TEMPLATE_{名称}.png`（英文自动转大写） |
| 直接 Enter | 跳过该格子 |
| `q` | 结束并输出汇总 |

文件名含非法字符（`\ / : * ? " < > |`）时工具会提示重新输入。若文件已存在，会询问是否覆盖。

完成后终端输出汇总：

```
完成！共保存 15 个头像到 ./assets/character/
   #1: TEMPLATE_水哈.png
   #2: TEMPLATE_水姐.png
   ...
```

---

## 生成 assets.py

头像文件就绪后，运行 `button_extract` 扫描目录并生成代码：

```bash
python -m dev_tools.button_extract
```

生成的代码（`module/character/assets.py`）：

```python
from module.base.template import Template

TEMPLATE_水哈 = Template(file='./assets/character/TEMPLATE_水哈.png')
TEMPLATE_水姐 = Template(file='./assets/character/TEMPLATE_水姐.png')
```

---

## 常见问题

### Q: 标定后绿框整体偏上/偏下

进入阶段二后用 `↑↓` 微调即可，不需要重新标定

### Q: 某列头像系统性偏移（列间距不均）

标定 2/3 时选的不是**最后一列**（`--cols` 指定的列数）。重新标定，确保第二个锚点选最右侧一列

### Q: 截图中头像不完整（边缘被裁掉）

框选时稍微缩小一点，确保选区完全在头像内部，避免选到相邻头像的边缘