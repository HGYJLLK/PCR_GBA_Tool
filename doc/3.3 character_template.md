# 3.3 character_template

本文说明如何在新角色上线时，将其追加到项目的角色识别系统中。

---

## 涉及的文件

| 文件 | 说明 | 维护方式 |
|------|------|------|
| `assets/icons/unit/{uid}.png` | 从官网下载的原始图标 | 自动（脚本） |
| `assets/icons/unit_cropped/{uid}.png` | 裁剪后的头像 | 自动（脚本） |
| `assets/icons/unit_names.json` | UID → 显示名（含星级）映射 | 自动（脚本覆盖生成） |
| `assets/character/TEMPLATE_*.png` | 用于模板匹配的头像文件 | 自动（脚本覆盖生成） |
| `module/character/assets.py` | Template 变量定义 | 自动（脚本覆盖生成） |
| `assets/icons/chara_name.json` | 角色别名搜索库 | **手动维护** |

---

## 命名规范

`build_character_assets.py` 将 `unit_names.json` 中的显示名转换为文件名和变量名：

| 转换规则 | 示例 |
|----------|------|
| `★` → `S`，空格 → `_` | `"霸瞳皇帝 ★1"` → `TEMPLATE_霸瞳皇帝_S1.png` |
| 括号内容保留在文件名中 | `"凯留(夏日) ★3"` → `TEMPLATE_凯留(夏日)_S3.png` |
| 变量名中括号、`&` 等非法字符 → `_` | `"初音&栞 ★1"` → `TEMPLATE_初音_栞_S1` |
| 只处理 ★1 / ★3 / ★6 | 其他星级跳过 |

---

## 常规使用：官网已收录新角色

依次运行三个脚本即可，步骤 1、2 自动跳过已有文件，只处理新增内容

```bash
# 下载图标（已有的自动 skip，更新 unit_names.json）
python dev_tools/download_icons.py

# 裁剪图标（已有的自动 skip）
python dev_tools/crop_icons.py

# 重建 TEMPLATE 和 assets.py
python dev_tools/build_character_assets.py
```

> **注意**：步骤 3 会先删除所有旧的 `TEMPLATE_*.png`，再从 `unit_cropped/` 全量重建。
> 这是设计上的全量替换——因为步骤 1、2 已确保所有角色的图都在，重建是安全的。

---

## 手动维护：官网尚未收录

官网 `unit_names.json` 还没更新时，需要手动处理

### 游戏画面

将游戏切换到包含角色头像的界面，运行：

```bash
python dev_tools/droidcast_raw.py
```

截图保存到 `logs/ui/screenshot_YYYYMMDD_HHMMSS.png`


> 截图分辨率必须为 **1280×720**

---

### 头像提取工具

```bash
python dev_tools/extract_avatars.py --input logs/ui/screenshot_20240101_120000.png

# 指定输出目录（默认 ./assets/character）
python dev_tools/extract_avatars.py --input logs/ui/screenshot_20240101_120000.png --output ./assets/character
```

工具会打开一个 OpenCV 窗口

---

#### 标定网格

依次框选 3 个头像，工具通过这 3 个锚点推算整个网格的位置和间距：

| 步骤 | 框选目标 | 作用 |
|------|----------|------|
| 1/3 | 第 1 行第 1 列（R1C1） | 确定网格左上角锚点 |
| 2/3 | 第 1 行最后一列（R1C_last） | 跨整行测量，推算列间距 |
| 3/3 | 第 2 行第 1 列（R2C1） | 确定行间距 |

**操作方式**：

1. 在窗口上拖拽鼠标框选头像
2. 松手后，工具自动将选区修正为正方形（**黄框**预览，灰框为原始选区）
3. 按 **Enter** 接受；若位置不准，重新拖拽即可
4. 按 **q** 或 **ESC** 退出

---

#### 垂直微调

标定完成后，绿色网格框叠加在图像上，检查是否与头像完全对齐，用键盘微调 Y 轴：

| 按键 | 效果 |
|------|------|
| `↑` / `↓` | 上下移动 1px |
| `w` / `s` | 上下移动 5px |
| `c` | 放弃，返回重新标定 |
| `Enter` | 确认，进入命名阶段 |
| `q` / `ESC` | 退出工具 |

---

#### 逐个命名保存

工具逐个高亮显示头像（当前格蓝色边框 + 右上角 3× 放大预览），在**终端**输入角色名：

```
共 16 个格子，开始逐个命名
  输入名称 → TEMPLATE_<名称>.png  |  Enter=跳过  |  q=结束

  [ 1/16] 角色名（Enter=跳过，q=结束）: 水哈
    已保存 → ./assets/character/TEMPLATE_水哈.png
  [ 2/16] 角色名（Enter=跳过，q=结束）: 水姐
    已保存 → ./assets/character/TEMPLATE_水姐.png
  [ 3/16] 角色名（Enter=跳过，q=结束）:
    跳过
  ...
```

| 输入 | 行为 |
|------|------|
| 角色名 | 保存为 `TEMPLATE_{名称}.png`（英文自动转大写） |
| 直接 Enter | 跳过该格子 |
| `q` | 结束并输出汇总 |

文件名含非法字符（`\ / : * ? " < > |`）时工具会提示重新输入。若文件已存在，会询问是否覆盖。

完成后终端输出汇总：

```
完成！共保存 15 个头像到 ./assets/character/
   #1: TEMPLATE_水哈.png
   #2: TEMPLATE_水姐.png
   ...
```

### 步骤 3：手动追加到 `assets.py`

头像文件就绪后，运行 `button_extract` 扫描目录并生成代码：

```bash
python -m dev_tools.button_extract
```

生成的代码（`module/character/assets.py`）：

```python
from module.base.template import Template

TEMPLATE_水哈 = Template(file='./assets/character/TEMPLATE_水哈.png')
TEMPLATE_水姐 = Template(file='./assets/character/TEMPLATE_水姐.png')
```

---

## 追加别名

`assets/icons/chara_name.json` 不会被任何脚本修改，**必须手动维护**

格式为 `"4位基础ID": [别名数组]`，Key 是 UID 前4位（去掉星级后缀）：

```json
"1323": [
  "露易丝玛莉",
  "ルイーズ・マリー",
  "Louismaria",
  "路易斯",
  "玛莉"
]
```

别名数组可以包含：中文官名、日文名、英文名、社区绰号、emoji 等，供选角时模糊搜索使用。

---

## 常见问题

### Q: 运行步骤 3 后某个角色的 TEMPLATE 消失了

`build_character_assets.py` 要求对应的 `unit_cropped/{uid}.png` 存在。原因通常是步骤 1 下载失败或步骤 2 被跳过。重新运行步骤 1（加 `--clean` 可强制重下）和步骤 2（加 `--force` 可强制重裁），再运行步骤 3。

### Q: 如何强制重新下载/重裁所有图标

```bash
python dev_tools/download_icons.py --clean   # 删除已有 PNG 后重新下载
python dev_tools/crop_icons.py --force       # 强制覆盖已有裁剪结果
python dev_tools/build_character_assets.py
```

### Q: 新角色只出现了 ★1，没有 ★3

说明官网上该角色还没有 ★3 图标（`{uid}31.webp` 不存在），等官网更新后重新运行步骤 1～3 即可。