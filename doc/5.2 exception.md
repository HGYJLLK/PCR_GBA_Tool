# 异常处理

本文档介绍 PCR_GBA_Tool 的异常体系。

## 异常分类

### 任务控制类

| 异常 | 说明 | 处理方式 |
|------|------|----------|
| `TaskEnd` | 任务正常结束 | 捕获并继续 |
| `ScriptEnd` | 脚本正常结束 | 捕获并退出 |
| `ProcessComplete` | 某个处理阶段结束 | 捕获并继续 |
| `GamePageUnknownError` | 无法识别当前页面 | 抛给上层处理 |

### 设备连接类

| 异常 | 说明 | 处理方式 |
|------|------|----------|
| `RequestHumanTakeover` | 需要人工介入 | 致命，退出程序 |
| `EmulatorNotRunningError` | 模拟器未运行 | 可恢复，重试 |
| `GameNotRunningError` | 游戏未运行 | 可恢复，重启游戏 |
| `GameStuckError` | 游戏卡住 | 可恢复，重启游戏 |
| `GameTooManyClickError` | 点击循环 | 可恢复，重启游戏 |

### 检测识别类

| 异常 | 说明 |
|------|------|
| `DetectionError` | 检测基类 |
| `PatternDetectionError` | 模板匹配异常 |
| `ImageDetectionError` | 图像识别异常 |
| `TextDetectionError` | 文本识别异常 |

### 其他类型

| 分类 | 异常 |
|------|------|
| 资源类 | `ResourceExhausted` |
| 系统状态 | `SystemStuck`, `SystemOverload`, `SystemConfigError` |
| 数据处理 | `ProcessingError`, `DataValidationError`, `AlgorithmError`, `ConversionError` |
| 外部服务 | `ExternalServiceError`, `NetworkConnectionError`, `APIServiceError`, `DatabaseError` |
| 用户交互 | `UserIntervention`, `UserInputRequired`, `UserDecisionRequired` |

## 核心异常处理

### pcr.py 中的处理逻辑

```python
def run(self, command):
    try:
        self.__getattribute__(command)()
        return True  # 任务成功

    except TaskEnd:
        return True  # 任务正常结束

    # 可恢复错误 - 返回 False
    except GameNotRunningError as e:
        logger.warning(e)
        return False

    except (GameStuckError, GameTooManyClickError) as e:
        logger.error(e)
        self.device.sleep(10)
        return False

    # 致命错误 - 退出程序
    except RequestHumanTakeover:
        logger.critical("Request human takeover")
        exit(1)

    except Exception as e:
        logger.exception(e)
        exit(1)
```

### 错误分类

```
                    异常
                     │
        ┌────────────┴────────────┐
        │                         │
   可恢复错误                  致命错误
   (return False)            (exit(1))
        │                         │
   ┌────┴────┐              ┌─────┴─────┐
   │         │              │           │
GameStuck  GameNot     Request      其他
Error     Running       Human       未知
          Error        Takeover     异常
```

## 使用示例

### 抛出任务结束

```python
from module.exception import TaskEnd

def daily_task(self):
    if self.is_daily_completed():
        raise TaskEnd("Daily already completed")
    # 执行任务
```

### 请求人工接管

```python
from module.exception import RequestHumanTakeover

def handle_error(self):
    if self.cannot_auto_recover():
        raise RequestHumanTakeover("需要人工处理验证码")
```

### 自定义异常

```python
from module.exception import ProcessingError

class MyCustomError(ProcessingError):
    """自定义处理错误"""
    pass
```

## 最佳实践

1. **优先使用现有异常类型**，保持一致性
2. **可恢复错误**用于临时问题（网络、卡顿）
3. **致命错误**用于需要人工干预的情况
4. **记录日志**后再抛出异常

```python
from module.logger import logger
from module.exception import GameStuckError

if self.is_stuck():
    logger.error("Game stuck for 60 seconds")
    raise GameStuckError("Screen not responding")
```
