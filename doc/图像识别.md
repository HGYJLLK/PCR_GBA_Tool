# 3. 图像识别

## Button 参数含义

- 代码位于 module/handler/assets.py

**参数详解：**

1. **area** (检测区域)

   - 格式：`(x1, y1, x2, y2)`
   - 含义：在这个矩形区域内检测按钮是否存在
   - 示例：`(1214, 653, 1268, 709)` 表示从坐标(1214,653)到(1268,709)的矩形区域
   - 用途：模板匹配时的搜索范围

2. **color** (期望颜色)

   - 格式：`(R, G, B)`
   - 含义：按钮区域内期望的主要颜色值
   - 示例：`(203, 215, 230)` 表示浅蓝灰色
   - 用途：颜色匹配验证，确保找到的是正确的按钮

3. **button** (点击区域)

   - 格式：`(x1, y1, x2, y2)`
   - 含义：实际点击的矩形区域
   - 示例：`(416, 294, 534, 400)`
   - 用途：确定检测成功后实际点击的位置

4. **file** (模板图片路径)
   - 格式：字符串路径
   - 含义：用于模板匹配的参考图片
   - 示例：`'./assets/LOGIN_CHECK.png'`
   - 用途：OpenCV 模板匹配的模板图像

> 注意：所有的坐标和颜色的 RGB 数值均为整数，不接受浮点数

## match_template_color 工作流

- 代码位于 module/base/button.py（206-239）

```python
def match_template_color(
    self, image, offset=(20, 20), similarity=0.85, threshold=30
):
    """
    模版匹配 + 颜色验证

    Args:
        image: 截图
        offset (int, tuple): 检测区域偏移
        similarity (float): 模板匹配相似度，0-1之间，默认0.85
        threshold (int): 颜色匹配阈值，默认30

    Returns:
        bool: 是否匹配成功
    """
    # 模板匹配
    template_match = self.match_luma(image, offset=offset, similarity=similarity)
    logger.debug(f"{self.name} 模板匹配结果: {template_match}")

    if template_match:
        # 颜色验证
        diff = np.subtract(self.button, self._button)[:2]
        area = area_offset(self.area, offset=diff)
        color = get_color(image, area)
        color_match = color_similar(
            color1=color, color2=self.color, threshold=threshold
        )
        logger.debug(
            f"{self.name} 颜色匹配 - 实际颜色: {color}, 期望颜色: {self.color}, 匹配结果:{color_match}"
        )
        return color_match
    else:
        logger.debug(f"{self.name} 模板匹配失败")
        return False
```

### 模板匹配 (match_luma)

- 在 area 区域内搜索模板图片
- 使用 OpenCV 的归一化相关系数匹配
- 相似度超过 0.85 认为找到匹配

```python
# 裁剪搜索区域
image_crop = crop(image, offset + self.area)

# 转换为灰度图
image_luma = rgb2luma(image_crop)

# OpenCV模板匹配
res = cv2.matchTemplate(image_luma, self.image_luma, cv2.TM_CCOEFF_NORMED)
_, sim, _, point = cv2.minMaxLoc(res)

# 检查相似度
return sim > similarity  # 默认0.85
```

### 颜色验证

- 根据模板匹配结果调整颜色检测区域
- 获取调整后区域的平均 RGB 值
- 与期望颜色比较，阈值内认为匹配成功

```python
# 计算按钮位置偏移
diff = np.subtract(self.button, self._button)[:2]

# 调整颜色检测区域
area = area_offset(self.area, offset=diff)

# 获取该区域的平均颜色
color = get_color(image, area)

# 颜色相似度检查
return color_similar(color1=color, color2=self.color, threshold=threshold)
```

## 特征图运行流程机制

### area

```bash
+--------------------------------------------------+
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                [ 登 录 ]  ← 你看到的按钮         |
|                                                  |
|                                                  |
+--------------------------------------------------+
```

- 用截图工具框选按钮文字部分，得到坐标：area = (180, 649, 233, 708)

```bash
+--------------------------------------------------+
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|      ....................................        |
|      .                                  .        |
|      .        [180,649 → 233,708]       .        |
|      .            ┌──────────┐          .        |
|      .            │  [登 录] │          .        |
|      .            └──────────┘          .        |
|      ....................................        |
|                                                  |
+--------------------------------------------------+
```

- 这个就是定义的 area，按钮的实际位置范围，pcr 默认只在这里找

### offset

`def appear(self, button, offset=20, threshold=30, similarity=0.85) -> bool:`

- pcr 在图像识别这块，并不会死板在你定义的 area 范围内寻找，而是会根据你定义的 offset 值，往外扩展一点范围，然后再进行搜索：offset=(20,20)

```bash
offset = (20, 20)
→ 搜索区域 = area + (-20, -20, +20, +20)
           = (160, 629, 253, 728)

+--------------------------------------------------+
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|                                                  |
|   ┌──────────────────────────────────────┐       |
|   │  ← 扩大后的搜索窗口 (offset生效!)     │       |
|   │                                      │       |
|   │        ┌──────────┐                  │       |
|   │        │  [登 录] │ ← 实际按钮       │       |
|   │        └──────────┘                  │       |
|   │                                      │       |
|   └──────────────────────────────────────┘       |
|                                                  |
+--------------------------------------------------+
```

- offset 的作用就是往外扩展一点范围，让 pcr 有更多的搜索空间，从而找到更准确的按钮位置
- 也是一个“安全缓冲区”，防止按钮因分辨率/缩放偏移而漏检

### 模板图

- 代码位于 module/handler/assets.py
- 其每个按钮定义中的 file 属性就是模板图的路径
- 它是某个界面的关键特征部分，模板图越小、特征越明显越好（比如带文字、独特图标）

```bash
模板图（file）:
┌──────────┐
│  [登 录] │  ← 53×59 像素的小图
└──────────┘
```

pcr 会把这个小图，在搜索窗口里逐像素滑动，尝试匹配

```bash
搜索窗口：
┌──────────────────────────────┐
│ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │
│ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │
│ ░░░░ [登 录]? ← 滑到这里     │ ← 计算相似度
│ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │
└──────────────────────────────┘
```

每滑一次，就计算一个 相似度分数（sim）：

- 完全一样 → sim = 1.0
- 差不多 → sim = 0.88
- 完全不像 → sim = 0.3

---

- 这里的滑动匹配，即逐像素滑动 + 计算相似度
- 它是由 OpenCV 底层做的
- 即：`res = cv2.matchTemplate(image_luma, self.image_luma, cv2.TM_CCOEFF_NORMED)`

## 模版图运行流程机制

- 和特征图运行流程机制差不多，但是模板图的运行是将你截的图作为模板
- pcr 会根据你给的 area 范围去获取每次截图的那部分，然后和模板图进行匹配

---

## 开发者的工作

### 模板图制作

- 运行 tests/droidcast_raw_demo.py，生成 test_droidcast_raw.png
- 将生成的图片放到 PS 中做处理

1. 在左侧工具栏中选择 **“矩形选框工具”** ，框出你想要保留的区域，这时画面会出现流动的虚线（蚂蚁线）
2. 点击图层面板底部的 **“添加图层蒙版”** 按钮（它是一个**矩形中间有个圆形**的图标），点击后，你会发现图片图层旁边多了一个白色的缩略图，这就是蒙版
   > 此时的效果是，只剩下你保留的区域，其他地方全都是白色的缩略图，即白色或灰白格子，这是 PS 表示透明区域的方式
3. 顶部菜单栏找到**窗口 -> 图层**，完全图层的新建
4. 将新建的图层拖到最下方，并且选中它
5. 按 D 键复位颜色，再按 Alt + delete 填充黑色
   > 此时的效果就是只剩下你保留的区域，其他全部置于黑色
6. 顶部菜单栏找到文件 -> 导出 `PNG`，然后快速导出 `PNG`
7. 将图片保存到根目录下 assets 里的任何一个文件夹当中

---

- 这样就得到了模板图

### 特征图制作

- 运行 tests/droidcast_raw_demo.py，生成 test_droidcast_raw.png
- 修改 dev_tools/template_extract.py 中的配置

```python
OUTPUT_TEMPLATE = "./assets/pcr/TEMPLATE_TEST.png"

# 提取区域 (x1, y1, x2, y2)
# 假设匹配位置是 (697, 367)，尺寸是 49×31
EXTRACT_AREA = (697, 367, 746, 398)  # (697, 367, 697+49, 367+31)
```

- 修改输出路径以及需要提取的区域
- 运行 dev_tools/template_extract.py：`python dev_tools/template_extract.py`

### 运行工具生成代码

- 运行 dev_tools 的 button_extract.py：`python dev_tools/button_extract.py`
- 它会自动搜索 assets/ 目录下所有的图片
- 然后会在 module/ 对应的文件夹中生成 assets.py

## 特征图与模版图应用场景

- 特征图用于 Gif、动态内容
- 模版图用于固定的 UI 元素
