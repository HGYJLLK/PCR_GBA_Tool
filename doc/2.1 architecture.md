# 2.1 architecture

本文档介绍 PCR_GBA_Tool 的架构设计

```bash
┌─────────────────────────────────────────────────────────────┐
│                         pcr.py                               │
│                      (任务调度器)                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Handler 层                            │
│              (login.py, train/combat.py, ...)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         UI 层                                │
│                  (ui.py, page.py, scroll.py)                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Base 层                               │
│          (ModuleBase, Button, Template, Timer)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Device 层                              │
│          (Device, Connection, Screenshot, Control)          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Config 层                              │
│      (PriconneConfig, ConfigUpdater, GeneratedConfig)       │
└─────────────────────────────────────────────────────────────┘
```

## 任务调度器 (pcr.py)

任务的调度和执行

```python
class PCRGBATool:
    def loop(self):
        """主循环，启动任务"""

    def run(self, command):
        """执行指定任务，处理异常"""

    def start(self):
        """启动游戏并登录"""
```

```bash
┌──────────────────────┐
│     run(command)     │
└──────────┬───────────┘
           │
           ▼
    ┌──────────────┐
    │   执行任务    │
    └──────┬───────┘
           │
     ┌─────┴─────┐
     │   异常?   │
     └─────┬─────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌────────┐   ┌────────┐
│可恢复  │   │致命错误│
│return  │   │exit(1) │
│False   │   │        │
└────────┘   └────────┘
```

**可恢复错误**:
- `GameStuckError` - 游戏卡住
- `GameNotRunningError` - 游戏未运行
- `GameTooManyClickError` - 点击循环

**致命错误**:
- `RequestHumanTakeover` - 需要人工介入
- 其他未捕获异常

## Handler 层

实现具体的游戏业务逻辑

```python
class LoginHandler(UI):
    """登录处理器"""
    def app_start(self):
        """启动应用并处理登录流程"""
```

Handler 继承自 UI 类，可以：
- 页面导航
- 图像识别
- 设备控制

## UI 层

页面导航和通用 UI 操作

```python
class UI(ModuleBase):
    def ui_goto(self, destination):
        """导航到指定页面"""

    def ui_ensure(self, destination):
        """确保在指定页面"""

    def ui_click(self, click_button, check_button):
        """点击并等待确认"""
```

详见 [ui_navigation.md](ui_navigation.md)

### 4. Base 层

**职责**: 提供基础能力

#### ModuleBase
```python
class ModuleBase:
    def appear(self, button):
        """检测按钮是否出现"""

    def appear_then_click(self, button):
        """出现则点击"""

    def wait_until_appear(self, button):
        """等待按钮出现"""
```

#### Button / Template
图像识别的两种方式，详见 [image_recognition.md](image_recognition.md)

#### Timer
时间控制和防抖/节流，详见 [image_recognition.md](image_recognition.md#timer-类)

### 5. Device 层

**职责**: 设备交互抽象

```
Device
├── Connection (ADB 连接管理)
├── Screenshot (截图获取)
│   ├── DroidCast
│   ├── ADB
│   └── uiautomator2
└── Control (触控操作)
    ├── MaaTouch
    ├── Minitouch
    └── ADB
```

**安全机制**:
- **卡死检测**: 60秒/300秒超时计时器
- **点击循环检测**: 记录最近15次点击，防止无限循环
- **截图缓存**: 避免重复截图

### 6. Config 层

**职责**: 配置管理

详见 [config.md](config.md)

## 设计模式

### 1. 懒加载模式 (cached_property)

避免不必要的初始化开销：

```python
class PCRGBATool:
    @cached_property
    def config(self):
        return PriconneConfig(config_name=self.config_name)

    @cached_property
    def device(self):
        return Device(config=self.config)
```

### 2. 状态机模式 (Page Navigation)

页面之间形成状态机：

```
page_main ──ADVENTURE──► page_adventure ──TEAM_BATTLE──► page_team_battle
    │                         │
    └──GO_TO_MENU──► page_menu
```

### 3. 模板方法模式

Handler 继承 UI，UI 继承 ModuleBase：

```
ModuleBase (基础能力)
    │
    └── UI (导航能力)
         │
         └── Handler (业务逻辑)
```

### 4. 策略模式 (Screenshot/Control)

截图和控制方法可配置切换：

```python
# 配置选择策略
Emulator_ScreenshotMethod = "DroidCast_raw"
Emulator_ControlMethod = "MaaTouch"
```

## 数据流

### 执行流程

```
1. 用户运行 pcr.py
       │
       ▼
2. 初始化 Config (读取 JSON)
       │
       ▼
3. 初始化 Device (连接模拟器)
       │
       ▼
4. 执行 start 任务
       │
       ▼
5. LoginHandler 处理登录
       │
       ├── 截图
       ├── 识别按钮
       ├── 点击操作
       └── 循环直到登录成功
       │
       ▼
6. 任务完成，返回结果
```

### 配置绑定流程

```
YAML 定义
    │
    ▼
config_updater.py
    │
    ├──► config_generated.py (Python 类)
    │
    └──► template.json (配置模板)
            │
            ▼
        用户配置.json
            │
            ▼
        PriconneConfig.bind()
            │
            ▼
        config.Emulator_Serial (属性访问)
```

## 扩展指南

### 添加新任务

1. 在 `module/handler/` 创建新的 Handler：

```python
class NewTaskHandler(UI):
    def new_task(self):
        self.ui_ensure(page_xxx)
        # 业务逻辑
```

2. 在 `pcr.py` 中添加任务方法：

```python
def new_task(self):
    from module.handler.new_task import NewTaskHandler
    NewTaskHandler(self.config, self.device).new_task()
```

3. 更新配置定义并重新生成

### 添加新页面

1. 在 `module/ui/page.py` 添加页面定义：

```python
page_new = Page(NEW_PAGE_CHECK)
page_new.link(button=GO_TO_MAIN, destination=page_main)
page_main.link(button=GO_TO_NEW, destination=page_new)
```

2. 在 `assets/ui/` 添加对应的按钮图片

3. 运行 `python dev_tools/button_extract.py` 生成 assets.py

## 依赖关系

```
pcr.py
    └── module/
        ├── config/
        │   ├── config.py ──► config_generated.py
        │   ├── config_updater.py
        │   └── deep.py, watcher.py, utils.py
        │
        ├── device/
        │   ├── device.py ──► connection.py, screenshot.py, control.py
        │   └── method/ (DroidCast, MaaTouch, ...)
        │
        ├── base/
        │   ├── base.py ──► button.py, template.py, timer.py
        │   ├── decorator.py (cached_property, run_once)
        │   └── utils.py (图像处理工具)
        │
        ├── ui/
        │   ├── ui.py ──► page.py
        │   └── scroll.py, assets.py
        │
        ├── handler/
        │   └── login.py ──► assets.py
        │
        ├── exception.py
        └── logger.py
```
