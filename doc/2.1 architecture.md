# 2.1 architecture

本文档介绍 PCR_GBA_Tool 的架构设计

```bash
┌─────────────────────────────────────────────────────────────┐
│                         pcr.py                               │
│                      (任务调度器)                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Handler 层                            │
│              (login.py, train/combat.py, ...)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         UI 层                                │
│                  (ui.py, page.py, scroll.py)                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Base 层                               │
│          (ModuleBase, Button, Template, Timer)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Device 层                              │
│          (Device, Connection, Screenshot, Control)          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Config 层                              │
│      (PriconneConfig, ConfigUpdater, GeneratedConfig)       │
└─────────────────────────────────────────────────────────────┘
```

## 任务调度器 (pcr.py)

任务的调度和执行

```python
class PCRGBATool:
    def loop(self):
        """主循环，启动任务"""

    def run(self, command):
        """执行指定任务，处理异常"""

    def start(self):
        """启动游戏并登录"""
```

```bash
┌──────────────────────┐
│     run(command)     │
└──────────┬───────────┘
           │
           ▼
    ┌──────────────┐
    │   执行任务    │
    └──────┬───────┘
           │
     ┌─────┴─────┐
     │   异常?   │
     └─────┬─────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌────────┐   ┌────────┐
│可恢复  │   │致命错误│
│return  │   │exit(1) │
│False   │   │        │
└────────┘   └────────┘
```

**可恢复错误**:
- `GameStuckError` - 游戏卡住
- `GameNotRunningError` - 游戏未运行
- `GameTooManyClickError` - 点击循环

**致命错误**:
- `RequestHumanTakeover` - 需要人工介入
- 其他未捕获异常

## Handler 层

实现具体的游戏业务逻辑

```python
class LoginHandler(UI):
    """登录处理器"""
    def app_start(self):
        """启动应用并处理登录流程"""
```

Handler 继承自 UI 类，可以：
- 页面导航
- 图像识别
- 设备控制

## UI 层

页面导航和通用 UI 操作

```python
class UI(ModuleBase):
    def ui_goto(self, destination):
        """导航到指定页面"""

    def ui_ensure(self, destination):
        """确保在指定页面"""

    def ui_click(self, click_button, check_button):
        """点击并等待确认"""
```

详见 [3.2 ui_navigation.md](3.2 ui_navigation.md)

## Base 层

提供基础方法

#### ModuleBase
```python
class ModuleBase:
    def appear(self, button):
        """检测按钮是否出现"""

    def appear_then_click(self, button):
        """出现则点击"""

    def wait_until_appear(self, button):
        """等待按钮出现"""
```

## Device 层

设备交互

```
Device
├── Connection (ADB 连接管理)
├── Screenshot (截图获取)
│   ├── DroidCast
│   ├── ADB
│   └── uiautomator2
└── Control (触控操作)
    ├── MaaTouch
    ├── Minitouch
    └── ADB
```

## Config 层

配置管理