# 开发者工具

本文档介绍 `dev_tools/` 目录下的开发辅助工具。

## 工具概览

| 工具 | 说明 |
|------|------|
| `button_extract.py` | 批量提取资源，生成 assets.py |
| `create_button.py` | 一体化按钮创建工具 |
| `create_button_auto.py` | 自动化按钮检测 |
| `extract_button_simple.py` | 简单的按钮坐标提取 |
| `find_button_coords.py` | 查找按钮坐标 |
| `button_creator.html` | Web UI 按钮选择工具 |

## button_extract.py

### 功能

批量处理 `assets/` 目录，自动生成所有模块的 `assets.py` 文件。

### 使用方法

```bash
python dev_tools/button_extract.py
```

### 工作流程

```
assets/
├── handler/
│   ├── LOGIN_CHECK.png       → Button 定义
│   ├── TEMPLATE_ICON.png     → Template 定义
│   └── LOGIN_CHECK.AREA.png  → 覆盖 area 属性
├── ui/
│   └── ...
└── train/
    └── ...

↓ 运行 button_extract.py ↓

module/
├── handler/assets.py
├── ui/assets.py
└── train/assets.py
```

### 文件命名规范

| 命名格式 | 生成类型 | 说明 |
|----------|----------|------|
| `NAME.png` | Button | 普通按钮 |
| `TEMPLATE_NAME.png` | Template | 模板（全屏搜索） |
| `NAME.AREA.png` | - | 覆盖检测区域 |
| `NAME.COLOR.png` | - | 覆盖颜色取样区域 |
| `NAME.BUTTON.png` | - | 覆盖点击区域 |
| `123xxx.png` | - | 数字开头，忽略 |

### 代码解析

```python
class ImageExtractor:
    """从截图中提取按钮定义"""

    def __init__(self, module, file):
        self.module = module
        self.name, self.ext = os.path.splitext(file)
        self.load()

    def extract(self, file):
        """提取区域和颜色"""
        image = load_image(file)
        bbox = get_bbox(image)  # 获取非黑色区域边界
        mean = get_color(image=image, area=bbox)  # 计算平均颜色
        return bbox, mean

    @property
    def expression(self):
        """生成代码"""
        return f'{self.name} = Button(area={self.area}, color={self.color}, ...)'
```

### 输出示例

```python
# module/handler/assets.py
from module.base.button import Button
from module.base.template import Template

# This file was automatically generated by dev_tools/button_extract.py.
# Don't modify it manually.

LOGIN_CHECK = Button(area=(600, 400, 680, 480), color=(100, 150, 255), button=(600, 400, 680, 480), file="./assets/handler/LOGIN_CHECK.png")
TEMPLATE_ICON = Template(file="./assets/handler/TEMPLATE_ICON.png")
```

## create_button.py

### 功能

一体化的交互式按钮创建工具，完整流程：

1. 自动截图游戏界面
2. 在浏览器中框选按钮区域
3. 输入按钮名称
4. 自动提取并保存
5. 生成 Button 代码

### 使用方法

```bash
python dev_tools/create_button.py
```

### 交互流程

```
═══════════════════════════════════════
             按钮提取工具
═══════════════════════════════════════

══════ STEP 1: 截图 ══════
请确保游戏界面显示你要提取的按钮,然后按 Enter...
✓ 已保存截图: ./temp_screenshot.png

══════ STEP 2: 选择按钮区域 ══════
正在打开浏览器...
✓ 已在浏览器中打开选择工具

请在浏览器中:
  1. 点击'选择截图'按钮,选择 temp_screenshot.png
  2. 在图片上拖动鼠标框选按钮区域
  3. 记下显示的坐标

══════ STEP 3: 输入按钮信息 ══════
请输入按钮名称 (例如: PHYSICAL_TEST): LOGIN_BUTTON
请输入按钮坐标 (从HTML工具中复制):
  左上角 X: 600
  左上角 Y: 400
  右下角 X: 680
  右下角 Y: 480

✓ 按钮名称: LOGIN_BUTTON
✓ 坐标: (600, 400, 680, 480)

══════ STEP 4: 提取并保存按钮 ══════
✓ 已保存按钮图片: ./assets/train/LOGIN_BUTTON.png
  尺寸: 80 × 80

══════ STEP 5: 更新 assets.py ══════
生成的 Button 定义:
  LOGIN_BUTTON = Button(area=(600, 400, 680, 480), color=(100, 150, 200), button=(600, 400, 680, 480), file="./assets/train/LOGIN_BUTTON.png")

请手动将上面的代码添加到:
  module/train/assets.py

═══════════════════════════════════════
               完成!
═══════════════════════════════════════
```

## button_creator.html

### 功能

Web 界面的按钮区域选择工具，配合 `create_button.py` 使用。

### 使用方法

1. 直接在浏览器中打开：

```bash
open dev_tools/button_creator.html  # macOS
start dev_tools/button_creator.html # Windows
```

2. 或通过 `create_button.py` 自动打开

### 操作步骤

1. 点击 "选择截图" 加载图片
2. 在图片上拖动鼠标框选区域
3. 查看右侧显示的坐标信息
4. 复制坐标用于创建 Button

## 工作流示例

### 添加新按钮的完整流程

```bash
# 1. 确保游戏运行并显示目标界面

# 2. 运行创建工具
python dev_tools/create_button.py

# 3. 按提示操作：截图 → 框选 → 输入名称和坐标

# 4. 将按钮图片移动到正确目录
mv assets/train/NEW_BUTTON.png assets/handler/

# 5. 运行批量提取更新所有 assets.py
python dev_tools/button_extract.py

# 6. 在代码中使用
from module.handler.assets import NEW_BUTTON
```

### 批量更新资源

游戏 UI 更新后，需要重新截取：

```bash
# 1. 替换 assets/ 目录下的旧图片

# 2. 重新生成所有 assets.py
python dev_tools/button_extract.py

# 3. 测试新资源是否工作
python -c "from module.handler.assets import *; print('OK')"
```

## 图片制作规范

### 截图要求

- 分辨率：1280 × 720
- 格式：PNG（推荐）或 GIF（动画按钮）

### 按钮图片制作

```
1. 截取完整游戏界面 (1280×720)
2. 用图像编辑工具将按钮区域以外涂黑
3. 只保留按钮本身的像素

示例：
┌────────────────────────────────────┐
│████████████████████████████████████│
│████████████████████████████████████│
│████████████┌────────┐█████████████│
│████████████│ 按钮   │█████████████│
│████████████└────────┘█████████████│
│████████████████████████████████████│
│████████████████████████████████████│
└────────────────────────────────────┘
```

### AREA/COLOR/BUTTON 覆盖

当需要分离检测区域和点击区域时：

```
原图 NAME.png
├── 检测这里（小范围，精确匹配）
└── 点击这里（大范围，容错点击）

NAME.AREA.png   → 只保留检测区域
NAME.BUTTON.png → 只保留点击区域
```

## 调试技巧

### 验证按钮提取

```python
from module.base.button import Button
from module.base.utils import load_image, get_bbox, get_color

# 加载图片
image = load_image('./assets/handler/TEST.png')

# 查看边界
bbox = get_bbox(image)
print(f"Area: {bbox}")

# 查看颜色
color = get_color(image, bbox)
print(f"Color: {color}")
```

### 测试模板匹配

```python
from module.base.template import Template
from module.base.utils import load_image

template = Template(file='./assets/train/TEMPLATE_TEST.png')
screenshot = load_image('./test_screenshot.png')

sim, button = template.match_result(screenshot)
print(f"Similarity: {sim:.3f}")
print(f"Position: {button.area}")
```

### 可视化匹配结果

```python
import cv2
from module.base.utils import load_image

screenshot = load_image('./test_screenshot.png')

# 绘制匹配位置
cv2.rectangle(screenshot, button.area[:2], button.area[2:], (0, 255, 0), 2)
cv2.imwrite('./debug_result.png', screenshot)
```

## 目录结构

```
dev_tools/
├── button_extract.py      # 批量资源提取
├── create_button.py       # 一体化创建工具
├── create_button_auto.py  # 自动检测工具
├── extract_buttons.py     # 提取工具（旧版）
├── extract_button_simple.py
├── find_button_coords.py  # 坐标查找
├── button_creator.html    # Web UI
└── button_selector.html   # Web UI（旧版）
```
