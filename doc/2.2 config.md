# 2.2 config

本文档详细介绍 PCR_GBA_Tool 的配置

三层架构：

```bash
YAML 定义 (开发者编写)
       │
       ▼
自动生成 (config_updater.py)
       │
       ├── config_generated.py (Python 类，提供代码补全)
       │
       └── template.json (配置模板)
              │
              ▼
用户配置 (*.json 文件)
```

## JSON 配置

```json
{
  "Pcr": {
    "Scheduler": {
      "Enable": true,
      "Command": "Pcr",
      "NextRun": "2020-01-01 00:00:00"
    },
    "Emulator": {
      "Serial": "auto",
      "PackageName": "com.bilibili.priconne",
      "ScreenshotMethod": "DroidCast_raw",
      "ControlMethod": "MaaTouch"
    },
    "Optimization": {
      "ScreenshotInterval": 0.3,
      "ClickInterval": 0.1
    }
  },
  "PcrDaily": {
    "Scheduler": {
      "Enable": true,
      "Command": "PcrDaily",
      "NextRun": "2020-01-01 05:00:00"
    }
  }
}
```

## PriconneConfig

代码位于：`module/config/config.py`

PriconneConfig 是配置系统的入口类，负责加载、绑定和保存配置。它将 JSON 配置转换为 Python 属性，方便代码中直接使用

```bash
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   JSON 配置                      PriconneConfig                 │
│                                                                 │
│   {                              config = PriconneConfig("maple") │
│     "Pcr": {                                                    │
│       "Emulator": {         →    config.Emulator_Serial         │
│         "Serial": "auto"         config.Emulator_ScreenshotMethod│
│       }                                                         │
│     }                            修改属性会自动保存到 JSON       │
│   }                                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

```python
from module.config.config import PriconneConfig

# 加载配置（config_name 对应 config/ 目录下的 JSON 文件名）
config = PriconneConfig(config_name="maple", task="Pcr")

# 读取配置 - 使用 "组名_参数名" 格式
serial = config.Emulator_Serial           # "auto"
method = config.Emulator_ScreenshotMethod  # "DroidCast_raw"

# 修改配置 - 自动保存到 JSON 文件
config.Emulator_Serial = "127.0.0.1:16384"
```

---

## 配置生成

定义 yaml 生成 Python 类和 JSON 模板

```bash
python -m module.config.config_updater
```

```bash
YAML 定义（开发者编写）                         自动生成
─────────────────────────────────────────────────────────────────
module/config/argument/
├── argument.yaml ───┐
├── task.yaml     ───┼──→ args.json ──┬──→ config_generated.py
├── default.yaml  ───┤                │
└── override.yaml ───┘                │
                                      ▼
config/template.json (旧) ────────────────→ template.json (新)
```

| 文件            | 说明                                         |
| --------------- | -------------------------------------------- |
| `argument.yaml` | 定义所有配置参数（类型、默认值、选项）       |
| `task.yaml`     | 定义任务与参数组的关系                       |
| `default.yaml`  | 覆盖参数默认值                               |
| `override.yaml` | 定义锁定值（不可改，如隐藏字段）             |
| `args.json`     | 合并后的中间文件，包含所有任务的完整参数定义 |

---

## Function 类

Function 封装任务的调度信息，用于任务调度器判断任务何时执行。

```python
from module.config.config import Function

# 从任务配置创建 Function
func = Function(config.data["PcrDaily"])

func.enable    # True - 是否启用
func.command   # "PcrDaily" - 任务命令
func.next_run  # datetime - 下次执行时间
```

---