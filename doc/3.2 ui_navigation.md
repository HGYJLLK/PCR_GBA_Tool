# 3.2 ui_navigation

本文档介绍 PCR_GBA_Tool 的 UI 导航

UI 导航实现了游戏界面之间的自动导航，类似于 GPS 导航：

```bash
当前位置: page_main (主界面)
目标位置: page_team_battle (公会战)

导航路径:
page_main → page_adventure → page_team_battle
```

## Page 类

代码位于：`module/ui/page.py`

Page 类 UI 导航，它将游戏界面抽象为"页面"，并通过 `link()` 方法建立页面间的导航关系。这样PCR_GBA_Tool就会自动计算任意两个页面之间的最短路径

```bash
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   Page 对象 = 一个游戏界面                                        │
│                                                                 │
│   ┌─────────────┐                                               │
│   │  page_main  │  check_button: 用于识别"我是否在这个页面"           │
│   │             │  links: 记录"从这里能去哪"                      │
│   └─────────────┘                                               │
│         │                                                       │
│         │ link(ADVENTURE, page_adventure)                       │
│         │     在 page_main 点击 ADVENTURE 按钮 → page_adventure │
│         ▼                                                       │
│   ┌──────────────────┐                                          │
│   │  page_adventure  │                                          │
│   └──────────────────┘                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

```python
from module.ui.page import Page
from module.ui.assets import MAIN_CHECK, ADVENTURE, page_adventure

# 创建页面：指定该页面的"特征按钮"（用于识别当前是否在此页面）
page_main = Page(MAIN_CHECK)

# 定义导航：从 page_main 点击 ADVENTURE 按钮可到达 page_adventure
page_main.link(button=ADVENTURE, destination=page_adventure)

# 注意：link() 是单向的！
# 上面只定义了 main → adventure，如果需要 adventure → main，还需要：
# page_adventure.link(button=GO_TO_MAIN, destination=page_main)
```

### `__init__(self, check_button)`

| 属性           | 类型   | 说明                                                  |
| -------------- | ------ | ----------------------------------------------------- |
| `check_button` | Button | 该页面的特征按钮，用于判断"当前是否在此页面"          |
| `links`        | dict   | 存放 check_button 所在的页面到其他页面的导航链接      |
| `name`         | str    | 页面名称，自动从变量名获取（如 `page_main`）          |
| `parent`       | Page   | 寻路计算后的"下一步"，由 `init_connection()` 自动设置 |

---

## UI 类

UI 类提供导航能力：

```python
from module.ui.ui import UI

class MyHandler(UI):
    def do_something(self):
        # 确保在目标页面
        self.ui_ensure(page_team_battle)
        # 执行操作
```

## 页面定义

### 当前页面结构

```python
# module/ui/page.py

# 主界面
page_main = Page(MAIN_CHECK)

# 冒险模式
page_adventure = Page(TEAM_BATTLE)
page_adventure.link(button=GO_TO_MAIN, destination=page_main)
page_adventure.link(button=TEAM_BATTLE, destination=page_team_battle)

# 公会战
page_team_battle = Page(TEAM_BATTLE_CHECK)
page_team_battle.link(button=GO_TO_MAIN, destination=page_main)

# 训练场
page_train = Page(TRAIN_CHECK)
page_train.link(button=GO_TO_MAIN, destination=page_main)
page_train.link(button=ADVENTURE, destination=page_adventure)

# 菜单界面
page_menu = Page(MENU_CHECK)
page_menu.link(button=GO_TO_MAIN, destination=page_main)

# 主界面的链接
page_main.link(button=ADVENTURE, destination=page_adventure)
page_main.link(button=GO_TO_MENU, destination=page_menu)

# 未知页面（兜底）
page_unknown = Page(None)
page_unknown.link(button=GO_TO_MAIN, destination=page_main)
```

### 页面关系图

```
                    ┌─────────────┐
                    │  page_main  │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │ page_menu  │  │page_advent │  │ page_train │
    └────────────┘  └─────┬──────┘  └────────────┘
                          │
                          ▼
                   ┌─────────────────┐
                   │page_team_battle │
                   └─────────────────┘
```

## 寻路算法

### 反向 BFS

`Page.init_connection()` 使用反向 BFS 算法计算路径：

```python
@classmethod
def init_connection(cls, destination):
    """从目标页面反向搜索，为每个页面设置 parent"""
    cls.clear_connection()  # 清空旧路径

    visited = {destination}
    while True:
        new = visited.copy()
        for page in visited:
            for link in cls.iter_pages():
                if link in visited:
                    continue
                # 如果 link 能到达 page
                if page in link.links:
                    link.parent = page  # 设置下一步
                    new.add(link)
        if len(new) == len(visited):
            break
        visited = new
```

### 算法示例

目标：`page_team_battle`

```
第 1 轮：
  - 检查谁能一步到达 page_team_battle
  - 发现 page_adventure.links 包含 page_team_battle
  - 设置 page_adventure.parent = page_team_battle

第 2 轮：
  - 检查谁能一步到达 page_team_battle 或 page_adventure
  - 发现 page_main.links 包含 page_adventure
  - 设置 page_main.parent = page_adventure

结果：
  page_main.parent = page_adventure
  page_adventure.parent = page_team_battle
  page_team_battle.parent = None (目标)
```

## 导航方法

### ui_get_current_page

获取当前所在页面：

```python
def ui_get_current_page(self, skip_first_screenshot=True):
    """遍历所有页面，找到当前所在页面"""
    timeout = Timer(10, count=20).start()

    while True:
        self.device.screenshot()

        if timeout.reached():
            break

        # 遍历所有注册的页面
        for page in Page.iter_pages():
            if page.check_button is None:
                continue
            if self.ui_page_appear(page=page):
                self.ui_current = page
                return page

        # 尝试返回主界面
        if self.appear_then_click(GO_TO_MAIN):
            timeout.reset()
            continue

    raise GamePageUnknownError
```

### ui_goto

导航到指定页面：

```python
def ui_goto(self, destination, offset=(30, 30)):
    """导航到目标页面"""
    # 计算路径
    Page.init_connection(destination)

    confirm_timer = Timer(0.3, count=1).start()

    while True:
        self.device.screenshot()

        # 检查是否到达目标
        if self.ui_page_appear(destination):
            if confirm_timer.reached():
                break
        else:
            confirm_timer.reset()

        # 查找当前页面并导航
        for page in Page.iter_pages():
            if page.parent is None or page.check_button is None:
                continue
            if self.ui_page_appear(page=page):
                # 找到下一步的按钮
                button = page.links[page.parent]
                self.device.click(button)
                confirm_timer.reset()
                break

    self.ui_current = destination
```

### ui_ensure

确保在指定页面：

```python
def ui_ensure(self, destination):
    """如果不在目标页面，则导航过去"""
    self.ui_get_current_page()

    if self.ui_current == destination:
        return False  # 已经在目标页面
    else:
        self.ui_goto(destination)
        return True  # 进行了导航
```

### ui_click

通用的点击等待方法：

```python
def ui_click(self, click_button, check_button, confirm_wait=1):
    """点击按钮并等待确认"""
    click_timer = Timer(10)
    confirm_timer = Timer(confirm_wait).start()

    while True:
        self.device.screenshot()

        # 检查是否完成
        if self.ui_process_check_button(check_button):
            if confirm_timer.reached():
                break
        else:
            confirm_timer.reset()

        # 点击按钮
        if click_timer.reached():
            if self.appear(click_button):
                self.device.click(click_button)
                click_timer.reset()
```

## 添加新页面

### 步骤 1: 添加按钮资源

在 `assets/ui/` 目录添加页面识别按钮的图片：

```
assets/ui/NEW_PAGE_CHECK.png
```

### 步骤 2: 生成 assets.py

```bash
python dev_tools/button_extract.py
```

### 步骤 3: 定义页面

在 `module/ui/page.py` 中：

```python
from module.ui.assets import NEW_PAGE_CHECK, GO_TO_NEW

# 创建新页面
page_new = Page(NEW_PAGE_CHECK)

# 定义从新页面可以去哪里
page_new.link(button=GO_TO_MAIN, destination=page_main)

# 定义其他页面如何到达新页面
page_main.link(button=GO_TO_NEW, destination=page_new)
```

### 步骤 4: 使用新页面

```python
class MyHandler(UI):
    def go_to_new_page(self):
        self.ui_ensure(page_new)
        # 在新页面执行操作
```

## 调试技巧

### 查看所有页面

```python
from module.ui.page import Page

for name, page in Page.all_pages.items():
    print(f"{name}: check={page.check_button}, links={list(page.links.keys())}")
```

### 检查路径计算

```python
from module.ui.page import Page, page_main, page_team_battle

# 计算到 page_team_battle 的路径
Page.init_connection(page_team_battle)

# 打印每个页面的下一步
for name, page in Page.all_pages.items():
    print(f"{name}.parent = {page.parent}")
```

### 手动测试导航

```python
# 测试脚本
from module.config.config import PriconneConfig
from module.device.device import Device
from module.ui.ui import UI
from module.ui.page import page_team_battle

config = PriconneConfig("cwj", "Pcr")
device = Device(config)

ui = UI(config, device)
ui.ui_ensure(page_team_battle)
print("导航完成！")
```

## 常见问题

### GamePageUnknownError

**原因**: 无法识别当前页面

**解决方案**:

1. 检查是否有弹窗遮挡
2. 确认页面的 check_button 资源正确
3. 添加新页面定义

### 导航循环

**原因**: 页面链接配置错误

**解决方案**:

1. 检查 page.link() 的 button 和 destination 是否正确
2. 确保每个页面都有返回主界面的路径

### 导航缓慢

**原因**: 页面切换需要等待动画

**解决方案**:

1. 调整 confirm_timer 的等待时间
2. 添加中间状态检测
