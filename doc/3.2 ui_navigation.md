# 3.2 ui_navigation

本文档介绍 PCR_GBA_Tool 的 UI 导航

UI 导航实现了游戏界面之间的自动导航，类似于 GPS 导航：

```bash
当前位置: page_main (主界面)
目标位置: page_team_battle (公会战)

导航路径:
page_main → page_adventure → page_team_battle
```

## Page 类

代码位于：`module/ui/page.py`

Page 类 UI 导航，它将游戏界面抽象为"页面"，并通过 `link()` 方法建立页面间的导航关系。这样PCR_GBA_Tool就会自动计算任意两个页面之间的最短路径

```bash
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   Page 对象 = 一个游戏界面                                        │
│                                                                 │
│   ┌─────────────┐                                               │
│   │  page_main  │  check_button: 用于识别"我是否在这个页面"           │
│   │             │  links: 记录"从这里能去哪"                      │
│   └─────────────┘                                               │
│         │                                                       │
│         │ link(ADVENTURE, page_adventure)                       │
│         │     在 page_main 点击 ADVENTURE 按钮 → page_adventure │
│         ▼                                                       │
│   ┌──────────────────┐                                          │
│   │  page_adventure  │                                          │
│   └──────────────────┘                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

```python
from module.ui.page import Page
from module.ui.assets import MAIN_CHECK, ADVENTURE, page_adventure

# 创建页面：指定该页面的"特征按钮"（用于识别当前是否在此页面）
page_main = Page(MAIN_CHECK)

# 定义导航：从 page_main 点击 ADVENTURE 按钮可到达 page_adventure
page_main.link(button=ADVENTURE, destination=page_adventure)

# 注意：link() 是单向的！
# 上面只定义了 main → adventure，如果需要 adventure → main，还需要：
# page_adventure.link(button=GO_TO_MAIN, destination=page_main)
```

### `__init__(self, check_button)`

| 属性           | 类型   | 说明                                                  |
| -------------- | ------ | ----------------------------------------------------- |
| `check_button` | Button | 该页面的特征按钮，用于判断"当前是否在此页面"          |
| `links`        | dict   | 存放 check_button 所在的页面到其他页面的导航链接      |
| `name`         | str    | 页面名称，自动从变量名获取（如 `page_main`）          |
| `parent`       | Page   | 寻路计算后的"下一步"，由 `init_connection()` 自动设置 |

---

## UI 类

代码位于：`module/ui/ui.py`

UI 类提供游戏界面导航能力，继承自 `ModuleBase`

开发功能模块时继承 UI 类，即可使用自动导航

### ui_ensure()

确保在指定页面，如果不在则自动导航过去

相当于 ui_goto() + ui_get_current_page()

```python
from module.ui.page import page_team_battle

# 确保在公会战页面
changed = self.ui_ensure(page_team_battle)
# changed: True 表示进行了导航，False 表示已经在目标页面
```

**参数说明**：

- **destination**：目标页面（Page 对象）
- **skip_first_screenshot**：是否跳过第一次截图，默认 True

**返回值**：`bool`，是否进行了导航

### ui_goto()

导航到指定页面

```python
# 直接导航到公会战页面
self.ui_goto(page_team_battle)
```

**参数说明**：

- **destination**：目标页面
- **offset**：按钮检测偏移量，默认 (30, 30)
- **skip_first_screenshot**：是否跳过第一次截图

### ui_get_current_page()

获取当前所在页面。`self.ui_current` 即是当前界面

```python
# 获取当前页面
current = self.ui_get_current_page()
logger.info(f"当前在 {current.name}")

# 也可以直接访问 self.ui_current
if self.ui_current == page_main:
    logger.info("在主界面")
```

**返回值**：`Page` 对象

**异常**：

- `GameNotRunningError`：游戏未运行
- `GamePageUnknownError`：无法识别当前页面（超时后抛出）

### ui_click()

"点击并等待"，用于界面切换。

```python
from module.ui.assets import CONFIRM_BUTTON, RESULT_CHECK

# 点击确认按钮，等待结果界面出现
self.ui_click(
    click_button=CONFIRM_BUTTON,   # 要点击的按钮
    check_button=RESULT_CHECK,     # 出现这个按钮表示完成
    confirm_wait=1                 # 等待确认时间
)
```

**参数说明**：

| 参数            | 类型                     | 说明                                   |
| --------------- | ------------------------ | -------------------------------------- |
| `click_button`  | Button                   | 要点击的按钮                           |
| `check_button`  | Button / callable / list | 检查完成的按钮                         |
| `appear_button` | Button / callable        | 出现时才点击，默认与 click_button 相同 |
| `additional`    | callable                 | 额外处理函数（如弹窗确认）             |
| `confirm_wait`  | float                    | 确认等待时间，默认 1 秒                |
| `offset`        | tuple                    | 检测偏移量，默认 (30, 30)              |
| `retry_wait`    | float                    | 重试间隔，默认 10 秒                   |

---
